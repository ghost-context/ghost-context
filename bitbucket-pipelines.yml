image: atlassian/default-image:4

definitions:
  caches:
    docker-buildx: ~/.docker/buildx
    nextjs: nextapp/.next/cache
  services:
    docker:
      memory: 3072  # 3GB for Docker service

pipelines:
  default:
    - step:
        name: Deploy to Cloud Run
        size: 2x  # 8GB RAM for Next.js build
        services:
          - docker
        script:
          # Set required environment variables
          - export APP_NAME=ghost-context
          - export APP_CODE_PATH=${BITBUCKET_CLONE_DIR}

          - export MORALIS_PLAN=starter
          - export MORALIS_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjY2ZWYwNGE2LTdlNjItNDdjZi1iMWJkLTMyM2RiN2NiYjBiMCIsIm9yZ0lkIjoiNDc0NDQyIiwidXNlcklkIjoiNDg4MDc5IiwidHlwZUlkIjoiYzZmNjViMTktZjJiYS00M2Q2LWI0MjMtMzc3OTA5MGQzYWYxIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NTk3NzE0MzgsImV4cCI6NDkxNTUzMTQzOH0.G4jWLOz_Sgh_nlyrew6B3IohXaSX4qP_91CQ6gNBN24
          - export POAP_API_KEY=mCconFlhkc8hv3YgBymasJQrhb3af3SktDECkEEKb31MQujIi6gxf5BkThc1qmopq4DpZN8FQBIBapZC8I18cO4yfZXIP6vmKi1OoCgVhSD4Ob5ea0foLk9GDmdJBZsB

          - export NEXT_PUBLIC_MORALIS_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJub25jZSI6IjY2ZWYwNGE2LTdlNjItNDdjZi1iMWJkLTMyM2RiN2NiYjBiMCIsIm9yZ0lkIjoiNDc0NDQyIiwidXNlcklkIjoiNDg4MDc5IiwidHlwZUlkIjoiYzZmNjViMTktZjJiYS00M2Q2LWI0MjMtMzc3OTA5MGQzYWYxIiwidHlwZSI6IlBST0pFQ1QiLCJpYXQiOjE3NTk3NzE0MzgsImV4cCI6NDkxNTUzMTQzOH0.G4jWLOz_Sgh_nlyrew6B3IohXaSX4qP_91CQ6gNBN24
          - export NEXT_PUBLIC_ETH_MAIN_API_KEY=54U-Tvp-BgpUcxI3hoSG558Fx21a5kIe
          - export NEXT_PUBLIC_MATIC_MAIN_API_KEY=54U-Tvp-BgpUcxI3hoSG558Fx21a5kIe
          - export NEXT_PUBLIC_ARB_MAIN_API_KEY=54U-Tvp-BgpUcxI3hoSG558Fx21a5kIe
          - export NEXT_PUBLIC_OPT_MAIN_API_KEY=54U-Tvp-BgpUcxI3hoSG558Fx21a5kIe
          - export NEXT_PUBLIC_BASE_MAIN_API_KEY=54U-Tvp-BgpUcxI3hoSG558Fx21a5kIe
          - export NEXT_PUBLIC_ZORA_MAIN_API_KEY=54U-Tvp-BgpUcxI3hoSG558Fx21a5kIe
          - export NEXT_PUBLIC_POAP_API_KEY=mCconFlhkc8hv3YgBymasJQrhb3af3SktDECkEEKb31MQujIi6gxf5BkThc1qmopq4DpZN8FQBIBapZC8I18cO4yfZXIP6vmKi1OoCgVhSD4Ob5ea0foLk9GDmdJBZsB
          - export NEXT_PUBLIC_NEYNAR_API_KEY=D716CE14-D8B7-4856-B032-7CDDD2BE8FFD
          - export NEXT_PUBLIC_PROJECT_ID=02718aeae375ec43c1b2dd06e21e7efb

          - export TF_VAR_app_env_vars="{\"MORALIS_API_KEY\":\"${MORALIS_API_KEY}\",\"POAP_API_KEY\":\"${POAP_API_KEY}\"}"

          # Clone devops repository
          - git clone git@bitbucket.org:sloanahrens/devops-cloud-run.git devops-cloud-run
          - cd devops-cloud-run/devops-cloud-run

          # Build devops container (required for deployment)
          - echo "Building DevOps container for deployment..."
          - cd docker
          - ./pull-devops-image.sh master

          # Validate bootstrap infrastructure is ready
          - echo "Validating bootstrap infrastructure..."
          - cd ../bootstrap
          - ./validate-bootstrap.sh
          - cd ..

          # Normalize branch name for image tag
          - export NORMALIZED_TAG=$(scripts/normalize-branch-tag.sh ${BITBUCKET_BRANCH})
          - echo "NORMALIZED_TAG is ${NORMALIZED_TAG}"

          # Build and push application container to Artifact Registry
          - echo "Building and pushing application container..."
          - export DOCKER_BUILD_ARGS="--build-arg NEXT_PUBLIC_PROJECT_ID=${NEXT_PUBLIC_PROJECT_ID} --build-arg NEXT_PUBLIC_ETH_MAIN_API_KEY=${NEXT_PUBLIC_ETH_MAIN_API_KEY} --build-arg NEXT_PUBLIC_MATIC_MAIN_API_KEY=${NEXT_PUBLIC_MATIC_MAIN_API_KEY} --build-arg NEXT_PUBLIC_ARB_MAIN_API_KEY=${NEXT_PUBLIC_ARB_MAIN_API_KEY} --build-arg NEXT_PUBLIC_OPT_MAIN_API_KEY=${NEXT_PUBLIC_OPT_MAIN_API_KEY} --build-arg NEXT_PUBLIC_BASE_MAIN_API_KEY=${NEXT_PUBLIC_BASE_MAIN_API_KEY} --build-arg NEXT_PUBLIC_NEYNAR_API_KEY=${NEXT_PUBLIC_NEYNAR_API_KEY} --build-arg NEXT_PUBLIC_AIRSTACK_KEY=${NEXT_PUBLIC_AIRSTACK_KEY}"
          - cd cloud-run
          - ./cloud-run.sh build-push-app-image ${NORMALIZED_TAG}

          # Deploy application with normalized tag
          - echo "Deploying application to Cloud Run with ${APP_NAME} and ${NORMALIZED_TAG}..."
          - ./cloud-run.sh apply ${NORMALIZED_TAG}

          # Test that the deployment is working
          - echo "Testing deployment health..."
          - |
            export SERVICE_URL=$(docker run --rm \
                -v $(pwd):/workspace \
                -w /workspace \
                -e GCP_SERVICE_ACCOUNT_KEY="$GCP_SERVICE_ACCOUNT_KEY" \
                devops:latest \
                terraform output -raw service_url 2>/dev/null | tail -n1)
            echo "Service URL: $SERVICE_URL"

            # Test with retries (up to 30 seconds)
            for i in {1..6}; do
              echo "Attempt $i: Testing $SERVICE_URL..."
              if docker run --rm -e GCP_SERVICE_ACCOUNT_KEY devops:latest curl -f -s -o /dev/null -w "%{http_code}\n" "$SERVICE_URL" | grep -q "200"; then
                echo "âœ… Health check passed! Service is running."
                exit 0
              fi
              echo "Waiting 5 seconds before retry..."
              sleep 5
            done
            echo "âŒ Health check failed after 30 seconds"
            exit 1

          # Display Service URL
          - echo "Service URL is $SERVICE_URL"

  # Custom pipelines
  custom:
    # Branch cleanup pipeline - triggered by webhook on PR merge (when "Close source branch" checked)
    branch-cleanup:
      - step:
          name: Destroy Branch Resources on Branch Deletion
          services:
            - docker
          script:
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # BRANCH DELETION CLEANUP PIPELINE
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            #
            # AUTOMATIC TRIGGER: When PR merged with "Close source branch" checked
            # MANUAL TRIGGER: Can also be run manually after deleting a branch
            #
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # HOW IT WORKS (AUTOMATIC):
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            #
            # When you merge a PR with "Close source branch" âœ“:
            #   1. Bitbucket merges PR and deletes the source branch
            #   2. Webhook fires "pullrequest:fulfilled" event
            #   3. triggerBranchCleanup Firebase function receives it
            #   4. Function triggers this pipeline for the deleted branch
            #   5. Pipeline destroys Cloud Run resources automatically
            #
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # HOW TO USE (MANUAL TRIGGER):
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            #
            # If you deleted a branch manually (not via PR merge):
            #
            # 1. Go to: Bitbucket â†’ Pipelines â†’ Run pipeline
            #
            # 2. Pipeline: Select "Custom: branch-cleanup"
            #
            # 3. Branch: Select the deleted branch from dropdown
            #    (or select "Custom" and manually type the branch name)
            #
            # 4. Click "Run"
            #
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            # WHAT GETS DESTROYED:
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            #
            # When you run cleanup for branch "feature/new-api":
            #   âœ… Terraform workspace: "feature-new-api" (normalized)
            #   âœ… Cloud Run service: "my-app-feature-new-api"
            #   âœ… All branch-specific resources in that workspace
            #
            # SAFETY:
            #   - Only destroys resources for the SPECIFIED branch
            #   - Master/main branches should never be deleted (org policy)
            #   - Each workspace is isolated (no cross-branch impact)
            #
            # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            # Set application name (CUSTOMIZE THIS FOR YOUR APP)
            - export APP_NAME=ghost-context

            # Determine deleted branch name:
            # - BRANCH_NAME variable (set by webhook when PR merged with "Close source branch")
            # - BITBUCKET_BRANCH (when manually triggered)
            # - BITBUCKET_TAG (when triggered for tag deletion)
            - export DELETED_BRANCH=${BRANCH_NAME:-${BITBUCKET_BRANCH:-${BITBUCKET_TAG}}}

            # Validate branch name exists
            - |
              if [ -z "$DELETED_BRANCH" ]; then
                echo "âŒ ERROR: No branch or tag name provided"
                echo "This pipeline must be manually triggered with a branch name."
                echo "Go to: Pipelines â†’ Run pipeline â†’ Custom: branch-cleanup"
                exit 1
              fi

            - echo "ğŸ—‘ï¸  Cleaning up Cloud Run resources for branch - ${DELETED_BRANCH}"
            - echo "ğŸ“¦ Application - ${APP_NAME}"
            - |
              if [ -n "$BRANCH_NAME" ]; then
                echo "ğŸ¤– Triggered automatically by PR merge webhook"
              else
                echo "ğŸ‘¤ Triggered manually"
              fi

            # Clone infrastructure repo
            - echo "Cloning infrastructure repo..."
            - git clone git@bitbucket.org:sloanahrens/devops-cloud-run.git devops-cloud-run
            - cd devops-cloud-run/devops-cloud-run

            # Pull devops container
            - echo "Pulling DevOps container..."
            - cd docker
            - ./pull-devops-image.sh master

            # Normalize branch name for resource identification
            - export NORMALIZED_BRANCH_TAG=$(../scripts/normalize-branch-tag.sh ${DELETED_BRANCH})
            - echo "ğŸ·ï¸  Normalized branch tag - ${NORMALIZED_BRANCH_TAG}"
            - echo "ğŸ¯ Target Cloud Run service - ${APP_NAME}-${NORMALIZED_BRANCH_TAG}"
            - echo "ğŸ“‚ Target Terraform workspace - ${NORMALIZED_BRANCH_TAG}"

            # Destroy Cloud Run resources for this branch
            - echo "ğŸš¨ Destroying Cloud Run resources..."
            - cd ../cloud-run
            - ./cloud-run.sh destroy ${NORMALIZED_BRANCH_TAG}

            - echo ""
            - echo "âœ… Successfully destroyed Cloud Run resources for deleted branch!"
            - echo "   Branch - ${DELETED_BRANCH}"
            - echo "   Service - ${APP_NAME}-${NORMALIZED_BRANCH_TAG}"
            - echo "   Workspace - ${NORMALIZED_BRANCH_TAG}"
            - echo ""
            - echo "ğŸ’° Tip - This cleanup prevents orphaned resources and saves GCP costs"


